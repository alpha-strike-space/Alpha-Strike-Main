import{c as i,s as p,a as f,i as y,b as I,f as b,d as u,e as C,g as S,l as k,h as E,r as P}from"./common-wl13Zeev.js";if("loading"in HTMLImageElement.prototype)document.querySelectorAll('img[loading="lazy"]').forEach(e=>{e.src=e.dataset.src});else{const t=document.createElement("script");t.src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.3.2/lazysizes.min.js",document.body.appendChild(t)}class M{constructor(e,n){this.url=e,this.containerId=n,this.ws=null,this.reconnectDelay=5e3}connect(){try{this.ws=new WebSocket(this.url),this.setupEventHandlers()}catch(e){console.error("WebSocket connection error:",e),this.scheduleReconnect()}}setupEventHandlers(){this.ws.onopen=()=>{console.log("WebSocket connection established.")},this.ws.onmessage=e=>{this.handleMessage(e)},this.ws.onerror=e=>{console.error("WebSocket error:",e)},this.ws.onclose=()=>{console.log(`WebSocket connection closed. Code: ${event.code}, Reason: ${event.reason}`),this.scheduleReconnect()}}handleMessage(e){let n;try{n=JSON.parse(e.data)}catch{console.log("WebSocket received non-JSON message or malformed JSON:",e.data);return}typeof n=="object"&&n!==null&&(Object.prototype.hasOwnProperty.call(n,"killer_name")||Object.prototype.hasOwnProperty.call(n,"victim_name")||Object.prototype.hasOwnProperty.call(n,"time_stamp"))?this.addNewIncident(n):console.log("WebSocket received valid JSON, but not recognized as an incident:",n)}addNewIncident(e){const n=document.getElementById(this.containerId);if(n){const o=i(e);o?(n.insertBefore(o,n.firstChild),p(localStorage.getItem("preferredLanguage")||"en"),f()):console.warn("Websocket: Incident item did not result in a displayable card:",e)}else console.error(`WebSocket: Container with ID ${this.containerId} not found for new incident.`)}scheduleReconnect(){setTimeout(()=>{this.connect()},this.reconnectDelay)}disconnect(){this.ws&&(this.ws.onclose=null,this.ws.close(1e3,"Client initiated disconnect"),this.ws=null,console.log("WebSocket connection intentionally closed."))}}const c=20;let l=1,d=!1;async function m(t){const e=document.getElementById("data-container");try{I(e,"loading.incidents"),await h(t),e&&e.scrollIntoView({behavior:"smooth",block:"start"})}catch(n){console.error("An unexpected error occurred:",n),e&&(e.textContent="An error occurred while loading data.")}}async function h(t){const e=document.getElementById("data-container");if(t<1){l=1,d=!1,e&&(e.innerHTML="",u([],"data-container",i,{noDataMessage:"No recent incidents found."})),r();return}try{const n=(t-1)*c,o=await b(c+1,n);if(o.length===0&&t>1){await h(t-1);return}l=t,d=o.length>c;const g=o.slice(0,c);if(g.length===0){e.innerHTML="",u([],"data-container",i,{noDataMessage:"No recent incidents found."}),r();return}const w=await Promise.all(g.map(s=>C(s).catch(a=>(console.error("Error processing incident:",s.id,a),null))));e.innerHTML="";for(const s of w)if(s){const a=i(s);a&&(e.appendChild(a),f(a),S(a,k[E]))}r()}catch(n){console.warn(`Failed to fetch page ${t}, trying page ${t-1}. Error:`,n),t>1?await h(t-1):(console.error("Error fetching initial incidents:",n),document.getElementById("data-container").textContent="Failed to load data.",l=1,d=!1,r())}}function r(){const t=document.getElementById("pagination-container");P({container:t,currentPage:l,hasNextPage:d,onPageClick:m})}document.addEventListener("DOMContentLoaded",async()=>{y("home"),await m(1),new M("wss://api.alpha-strike.space/ws/mails","data-container").connect()});

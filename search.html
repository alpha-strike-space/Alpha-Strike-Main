<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8"/>
    	<meta name="description" content="The Alpha-Strike Leaderboard or Killboard for Eve Frontier">
    	<meta name="keywords" content="Eve Frontier, PVP, Leaderboard, Killboard">
    	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    	<title>Alpha-Strike, Find your Content on the Frontier!</title>
    	<link rel="shortcut icon" href="favicon.png">
	<style>
	/* Base styles for the top navigation */
	.topnav {
    		display: flex;
    		align-items: center; /* Center items vertically */
    		background-color: #98888e;  /* Background color */
   		padding: 0 10px;         /* Side padding */
	}
	/* Navigation links */
	.topnav a {
    		color: #d1bea8;
    		text-align: center;
	 	padding: 14px 16px;
		text-decoration: none;
	}
	/* Active link styling */
	.topnav a.active {
		background-color: #f08080;	
		color: #000;
	}
	/* Hover effect for links */
	.topnav a:hover {
    		background-color: #f08080;
    		color: #000;
    		transform: scale(1.05); /* Slight enlargement */
    		box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
	}
    	/* Search Container with Options */
    	.search-container {
      		display: flex;
      		justify-content: center; /* centers children horizontally */
      		align-items: center;     /* aligns children vertically */
      		gap: 10px;               /* space between items */
      		margin-bottom: 20px;     /* space below the search container */
    	}
    	.search-container select,
    	.search-container input,
    	.search-container button {
     	 		padding: 5px;
      			border: 1px solid #ddd;
      			border-radius: 4px;
      			font-size: 0.9rem;
    	}
    	.search-container input {
      		width: 200px;
    	}
    	.search-container button {
     	 	background-color: #555;
      		color: #fff;
      		cursor: pointer;
      		border: none;
    	}
    	.search-container button:hover {
      		background-color: #777;
    	}
	/* Push the last element (if needed) to the far right on larger screens */
	.topnav a:last-child {
    		margin-left: auto;
	}    
	/* Language button animation */
	#animatedLangBtn {
  		margin-left: auto; /* Pushes the button to the right */
  		padding: 14px 16px; /* Match nav link padding for a larger, well-sized button */
  		font-size: 1rem; /* Increase font size for desktop */
 		background-color: #98888e;
  		color: #d1bea8;
  		border: none;
  		//border-radius: 4px;
  		cursor: pointer;
  		opacity: 1;
  		transition: opacity 0.5s ease, background-color 0.3s ease,
              	transform 0.3s ease, box-shadow 0.3s ease;
	}
    	#animatedLangBtn:hover {
      		background-color: #f08080;
	    	color: #000;
    		transform: scale(1.05); /* Slight enlargement */
    		box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
    	}
    	/* Remove default margins and paddings */
    	body {
      		/* Set the background image - update the URL to your image */
      		background-image: url('blackhole.jpg');
      		/* Ensure the image covers the entire viewport */
     	 	background-size: cover;
      		/* Center the image horizontally and vertically */
      		background-position: center;
      		/* Prevent the image from repeating */
      		background-repeat: no-repeat;
      		/* Optional: keep the background fixed while scrolling */
      		background-attachment: fixed;
    	}
    	/* Main Container */
    	.container {
      		max-width: 800px;
      		margin: 20px auto;
      		padding: 20px;
  		/* Using RGBA so only the background is semi-transparent */
  		background-color: rgba(255, 255, 255, 0.6);
      		border-radius: 8px;
    	  	box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    	}
    	h1 {
      		text-align: center;
      		color: #d1bea8;
      		margin-bottom: 30px;
    	}
    	/* Data Card for Search Results */
    	.data-card {
  		background-color: rgba(249, 249, 249, 0.7); /* 90% opaque light grey */
      		border: 1px solid #ddd;
      		padding: 15px;
      		margin-bottom: 15px;
      		border-radius: 5px;
    	}
    	.data-card h2 {
      		margin-top: 0;
      		font-size: 1.2rem;
      		color: #222;
    	}
    	.data-card p {
      		margin: 5px 0;
      		font-size: 0.9rem;
    	  	color: #555;
    	}
    	.timestamp {
      		font-style: italic;
      		color: #888;
      		font-size: 0.8rem;
     		margin-top: 10px;
    	}
	#totals-card {
  		text-align: center;
	}
	/* Victims get a blood color (dark red) */
	.victim {
 	 	color: #8B0000;
	}
	/* Killers get a gold color */
	.killer {
		color: #d24e01;
	}

	/* Mobile responsive: Vertical stacking for the navigation */
	@media screen and (max-width: 600px) {
		/* Prevent background scroll when selecting language in mobile view */
  		body {
    			background-attachment: scroll;  /* Let the background scroll on mobile */
  		}
    		.topnav {
        		flex-direction: column; /* Stack items vertically */
        		align-items: stretch;   /* Make each link fill the container width */
        		padding: 0;             /* Adjust padding on mobile if necessary */
    		}
    		.topnav a {
        		display: block;
        		text-align: left;       /* Left-align text or use center for a different style */
        		padding: 12px;          /* Adjust link padding for easier tapping */
        		margin: 0;              /* Remove any margin that might disrupt the layout */
        		border-bottom: 1px solid #ddd;  /* Optional divider between links */
    		}
    		/* Remove the extra margin on the last child and its divider line */
    		.topnav a:last-child {
        		margin-left: 0;
        		border-bottom: none;
    		}
  		#animatedLangBtn {
    			display: flex;      /* Make it a block-level element */
    			width: 100%;         /* Fill its container's width */
    			padding: 14px 16px;  /* Match the nav link padding */
    			text-align: center;
    			color: #d1bea8;
			background-color: #98888e;
    			border: none;
    			border-radius: 0;    /* Optionally, remove border radius */
    			cursor: pointer;
  		}
		/* Search will also be mobile friendly */
		.search-container {
        		flex-direction: column;
       		 	align-items: stretch;
    		}
    	    	.search-container select,
    		.search-container input,
    		.search-container button {
        		width: 100%;
			box-sizing: border-box;  /* Ensure padding and border don't cause overflow */
        		margin-bottom: 10px;
    		}
    		/* Remove extra bottom margin from the last element if needed */
    		.search-container button {
        		margin-bottom: 0;
    		}
	}
	</style>
</head>
<body>
	<!-- Top Navigation Bar with Language Switcher -->
	<div class="topnav">
		<a href="main.html" data-translate="navbar.home">Recently Stamped</a>
		<a href="monthly_killers.html" data-translate="navbar.killers">Leading Killers</a>
		<a href="monthly_systems.html" data-translate="navbar.systems">Leading Systems</a>
		<a href="monthly_victims.html" data-translate="navbar.victims">Leading Victims</a>
		<a class="active" href="search.html" data-translate="navbar.search">Search</a>
    		<!-- One animated button that cycles through language options -->
    		<button id="animatedLangBtn">EN</button>
  	</div>
  	<h1 data-translate="page.search-header">Search Stamped Mails</h1>
 	<div class="search-container">
        <!-- Dropdown to choose the search type -->
        <select id="searchType">
      		<option value="name" data-translate="search.byName">Search by Name</option>
      		<option value="system" data-translate="search.bySystem">Search by System</option>
        </select>
        <input type="text" id="searchQuery" placeholder="Enter search query..." />
        <button id="searchBtn">Search</button>
        </div>
  	<!-- Main Container for Search Results -->
  	<div class="container">
    		<h1 data-translate="search-results.header">Search Results</h1>
    		<!-- New container for the aggregated totals card -->
    		<div id="totals-card"></div>
    		<div id="results-container"></div>
  	</div>
    	<script type="text/javascript" src="translation_dictionary.js">
    		/* Nothing to add here, just calling a script */
	</script> 
	<script>
    	/** Function to format the timestamp if needed.
    	* Check your API docs to understand the timestamp's unit.
	*/	
	function formatTimestamp(ldapTimestamp) {
		// Convert the LDAP timestamp (in 100-nanosecond intervals) to milliseconds since 1601
  		const msSince1601 = ldapTimestamp / 10000;
  		// Calculate the difference between Jan 1, 1601 and Jan 1, 1970 in milliseconds
  		const epochDifference = 11644473600000; // 11,644,473,600,000 ms
	  	// Convert to Unix timestamp in milliseconds (since Jan 1, 1970)
	  	const msSince1970 = msSince1601 - epochDifference;
	  	// Create a new Date object and return its UTC string representation
	  	return new Date(msSince1970).toUTCString();
	}
    	/**
     	* Performs two API calls concurrently:
     	*   1. Incident search (detailed stamped mail results)
     	*   2. Aggregated totals (all time totals) from a different URL.
     	*
     	* Depending on the type (name or system), the URLs are built accordingly.
     	*/
    	async function searchData(query) {
      		// Get the search type from the dropdown.
      		const searchType = document.getElementById('searchType').value;
      		let incidentApiUrl, totalsApiUrl;
      
      		if (searchType === 'system') {
        		incidentApiUrl = `https://api.alpha-strike.space/incident?system=${encodeURIComponent(query)}`;
        		totalsApiUrl    = `https://api.alpha-strike.space/totals?system=${encodeURIComponent(query)}`;
      		} else if (searchType === 'name') {
        		incidentApiUrl = `https://api.alpha-strike.space/incident?name=${encodeURIComponent(query)}`;
        		totalsApiUrl    = `https://api.alpha-strike.space/totals?name=${encodeURIComponent(query)}`;
      		}
      
     		try {
        	// Fire both fetch requests concurrently.
        		const [incidentRes, totalsRes] = await Promise.all([
          			fetch(incidentApiUrl),
          			fetch(totalsApiUrl)
        	]);
        
        	if (!incidentRes.ok || !totalsRes.ok) {
          		throw new Error('Network error: ' + (incidentRes.status || totalsRes.status));
        	}
        		// Parse the responses.
        		const incidentData = await incidentRes.json();
        		const totalsData   = await totalsRes.json();
        		// Display the aggregated totals.
        		displayAggregateCard(totalsData, searchType);
        		// Display detailed search results.
        		displayResults(incidentData);
      		} catch (error) {
        		console.error("Error fetching search data:", error);
        		const currentLang = localStorage.getItem("preferredLanguage") || "en";
        		document.getElementById('results-container').innerText =
        		translations["search.error"][currentLang];
      		}
    	}
    	/**
     	* Displays the aggregated search totals as a card.
     	* For a name search, expects data like [{ name, total_kills, total_losses }].
     	* For a system search, expects data like [{ solar_system_id, solar_system_name, incident_count }].
     	* @param {Array} data - The aggregated data array.
     	* @param {string} type - Either "name" or "system".
     	*/
    	function displayAggregateCard(data, type) {
      		const totalsCard = document.getElementById("totals-card");
      		totalsCard.innerHTML = ""; // Clear any previous card.
      		if (!data || data.length === 0) {
        		totalsCard.innerText = "No aggregated data found.";
        		return;
      		}
      		if (type === "name") {
        		// Use the first element from the result (expected aggregated data for names).
        		const { name, total_kills, total_losses } = data[0];
        		totalsCard.innerHTML = `
          			<div class="card search-total">
            				<h2>${name}</h2>
            				<p><strong data-translate="card.totalVictims">Total Victims:</strong> ${total_kills}</p>
            				<p><strong data-translate="card.totalAwakenings">Total Awakenings:</strong> ${total_losses}</p>
          			</div>
        			`;
      		} else if (type === "system") {
        		const { solar_system_id, solar_system_name, incident_count } = data[0];
        		totalsCard.innerHTML = `
          			<div class="card search-total">
            				<h2>${solar_system_name}</h2>
            				<p><strong data-translate="card.solarSystemID">Solar System ID:</strong> ${solar_system_id}</p>
            				<p><strong data-translate="card.incidentCount">Incident Count:</strong> ${incident_count}</p>
          			</div>
        			`;
      		}
    	}
    	/**
     	* Display the search results.
     	* This function assumes that the API returns an array of objects.
     	* Adjust the innerHTML structure and property names based on your API response.
    	*/
    	function displayResults(data) {
		// Results
      		const container = document.getElementById('results-container');
      		container.innerHTML = ""; // Clear previous results
      		if (!data || data.length === 0) {
        		container.innerText = "No results found.";
        		return;
      		}
      		data.forEach(item => {
        		// Create a card element for each result
        		const card = document.createElement("div");
        		card.classList.add("data-card");
        		// Customize based on your API response structure.
        		card.innerHTML = `
          			<h2>
					<span class="killer">${item.killer_name}</span>
					<img src="pew.png" alt="vs" style="height:20px; vertical-align:middle;" />
					<span class="victim">${item.victim_name}</span>
				</h2>
          			<p><strong data-translate="card.lossType">Loss Type:</strong> ${item.loss_type}</p>
          			<p><strong data-translate="card.solarSystem">Solar System:</strong> ${item.solar_system_name} (ID: ${item.solar_system_id})</p>
          			<p class="timestamp"><strong data-translate="card.timestamp">Timestamp:</strong> ${formatTimestamp(item.time_stamp)}</p>
        			`;
        			container.appendChild(card);
	  	    	});
			// After creating the cards, update translations using the current language.
      			const currentLang = localStorage.getItem("preferredLanguage") || "en";
      			setLanguage(currentLang);
	    	}
    		// Event listener for the search button click
    		document.getElementById('searchBtn').addEventListener('click', () => {
      			const query = document.getElementById('searchQuery').value.trim();
      			if (query === "") {
        			alert("Please enter a search query.");
        			return;
      			}
      			searchData(query);
    		});
    		// Allow the Enter key to trigger the search as well
    		document.getElementById('searchQuery').addEventListener('keypress', (event) => {
      		if (event.key === "Enter") {
        		document.getElementById('searchBtn').click();
		}
    	});
	</script>
</body>
</html>
